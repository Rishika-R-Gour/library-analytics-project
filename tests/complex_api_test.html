<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Analytics Complex API Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .endpoint { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .endpoint h3 { margin-top: 0; color: #007bff; }
        .url { font-family: monospace; background: #e9ecef; padding: 5px 10px; border-radius: 4px; margin: 5px 0; }
        .test-btn { background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .test-btn:hover { background: #218838; }
        .login-btn { background: #007bff; }
        .login-btn:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; background: #d1ecf1; border-radius: 4px; border-left: 4px solid #bee5eb; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .success { background: #d4edda; border-left-color: #28a745; }
        .status { text-align: center; padding: 20px; }
        .healthy { color: #28a745; font-weight: bold; }
        .token-info { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .auth-section { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .ml-section { background: #f3e5f5; border-left: 4px solid #9c27b0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Library Analytics Complex API</h1>
        <p style="text-align: center;">Production-ready Flask API with JWT Authentication & ML Predictions</p>
        
        <div class="status" id="apiStatus">
            <p>Checking API status...</p>
        </div>

        <div class="token-info" id="tokenInfo" style="display:none;">
            <strong>üîë Authentication Token:</strong> <span id="tokenValue">Not logged in</span>
        </div>

        <!-- Authentication Section -->
        <div class="endpoint auth-section">
            <h3>üîê Authentication</h3>
            <div class="url">POST http://localhost:5001/api/auth/login</div>
            <button class="test-btn login-btn" onclick="login()">Login (admin/admin123)</button>
            <div id="result-auth" class="result" style="display:none;"></div>
        </div>

        <!-- Health Check -->
        <div class="endpoint">
            <h3>üíö Health Check</h3>
            <div class="url">GET http://localhost:5001/api/health</div>
            <button class="test-btn" onclick="testEndpoint('/api/health', 'GET', 'health')">Test Health</button>
            <div id="result-health" class="result" style="display:none;"></div>
        </div>

        <!-- Dashboard Stats -->
        <div class="endpoint">
            <h3>üìä Dashboard Statistics</h3>
            <div class="url">GET http://localhost:5001/api/dashboard/stats</div>
            <button class="test-btn" onclick="testEndpoint('/api/dashboard/stats', 'GET', 'stats', true)">Get Stats (Auth Required)</button>
            <div id="result-stats" class="result" style="display:none;"></div>
        </div>

        <!-- ML Predictions Section -->
        <div class="endpoint ml-section">
            <h3>üîÆ Overdue Predictions</h3>
            <div class="url">POST http://localhost:5001/api/predictions/overdue</div>
            <button class="test-btn" onclick="testOverduePredict()">Predict Overdue (Auth Required)</button>
            <div id="result-overdue" class="result" style="display:none;"></div>
        </div>

        <div class="endpoint ml-section">
            <h3>üë• Churn Predictions</h3>
            <div class="url">POST http://localhost:5001/api/predictions/churn</div>
            <button class="test-btn" onclick="testChurnPredict()">Predict Churn (Auth Required)</button>
            <div id="result-churn" class="result" style="display:none;"></div>
        </div>

        <div class="endpoint ml-section">
            <h3>üìö Book Recommendations</h3>
            <div class="url">GET http://localhost:5001/api/recommendations/1</div>
            <button class="test-btn" onclick="testEndpoint('/api/recommendations/1', 'GET', 'recommendations', true)">Get Recommendations (Auth Required)</button>
            <div id="result-recommendations" class="result" style="display:none;"></div>
        </div>

        <!-- Other Endpoints -->
        <div class="endpoint">
            <h3>üë§ Members List</h3>
            <div class="url">GET http://localhost:5001/api/members</div>
            <button class="test-btn" onclick="testEndpoint('/api/members', 'GET', 'members', true)">Get Members (Auth Required)</button>
            <div id="result-members" class="result" style="display:none;"></div>
        </div>

        <div class="endpoint">
            <h3>ü§ñ Models Status</h3>
            <div class="url">GET http://localhost:5001/api/models/status</div>
            <button class="test-btn" onclick="testEndpoint('/api/models/status', 'GET', 'models', true)">Check Models (Auth Required)</button>
            <div id="result-models" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        let authToken = null;

        // Check API status on page load
        window.onload = function() {
            fetch('http://localhost:5001/api/health')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('apiStatus').innerHTML = 
                        `<p class="healthy">‚úÖ Complex API is running! (v${data.version})</p>`;
                })
                .catch(error => {
                    document.getElementById('apiStatus').innerHTML = 
                        '<p style="color: #dc3545;">‚ùå Complex API is not responding. Make sure the server is running on port 5001.</p>';
                });
        };

        function login() {
            const resultDiv = document.getElementById('result-auth');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Authenticating...';
            
            fetch('http://localhost:5001/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: 'admin', password: 'admin123' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.token) {
                    authToken = data.token;
                    resultDiv.innerHTML = `‚úÖ Login successful!\nToken expires in: ${data.expires_in} seconds\nUser: ${data.user}`;
                    resultDiv.className = 'result success';
                    
                    // Show token info
                    document.getElementById('tokenInfo').style.display = 'block';
                    document.getElementById('tokenValue').textContent = authToken.substring(0, 50) + '...';
                } else {
                    resultDiv.innerHTML = '‚ùå Login failed: ' + (data.error || 'Unknown error');
                    resultDiv.className = 'result error';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '‚ùå Login error: ' + error.message;
                resultDiv.className = 'result error';
            });
        }

        function testEndpoint(endpoint, method, resultKey, requireAuth = false) {
            const resultDiv = document.getElementById('result-' + resultKey);
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Loading...';
            resultDiv.className = 'result';
            
            if (requireAuth && !authToken) {
                resultDiv.innerHTML = '‚ùå Authentication required. Please login first.';
                resultDiv.className = 'result error';
                return;
            }
            
            const headers = { 'Content-Type': 'application/json' };
            if (requireAuth) {
                headers['Authorization'] = 'Bearer ' + authToken;
            }
            
            fetch('http://localhost:5001' + endpoint, {
                method: method,
                headers: headers
            })
            .then(response => response.json())
            .then(data => {
                resultDiv.innerHTML = JSON.stringify(data, null, 2);
                resultDiv.className = 'result success';
            })
            .catch(error => {
                resultDiv.innerHTML = '‚ùå Error: ' + error.message;
                resultDiv.className = 'result error';
            });
        }

        function testOverduePredict() {
            const resultDiv = document.getElementById('result-overdue');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Predicting...';
            resultDiv.className = 'result';
            
            if (!authToken) {
                resultDiv.innerHTML = '‚ùå Authentication required. Please login first.';
                resultDiv.className = 'result error';
                return;
            }
            
            const testData = {
                loans: [
                    { loan_id: 1, member_id: 1, item_id: 1, loan_date: "2024-01-15", due_date: "2024-02-15" },
                    { loan_id: 2, member_id: 2, item_id: 2, loan_date: "2024-01-20", due_date: "2024-02-20" }
                ]
            };
            
            fetch('http://localhost:5001/api/predictions/overdue', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify(testData)
            })
            .then(response => response.json())
            .then(data => {
                resultDiv.innerHTML = JSON.stringify(data, null, 2);
                resultDiv.className = 'result success';
            })
            .catch(error => {
                resultDiv.innerHTML = '‚ùå Error: ' + error.message;
                resultDiv.className = 'result error';
            });
        }

        function testChurnPredict() {
            const resultDiv = document.getElementById('result-churn');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Predicting...';
            resultDiv.className = 'result';
            
            if (!authToken) {
                resultDiv.innerHTML = '‚ùå Authentication required. Please login first.';
                resultDiv.className = 'result error';
                return;
            }
            
            const testData = {
                members: [
                    { member_id: 1, total_loans: 5, days_since_last_loan: 45, membership_duration: 365 },
                    { member_id: 2, total_loans: 15, days_since_last_loan: 7, membership_duration: 730 }
                ]
            };
            
            fetch('http://localhost:5001/api/predictions/churn', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify(testData)
            })
            .then(response => response.json())
            .then(data => {
                resultDiv.innerHTML = JSON.stringify(data, null, 2);
                resultDiv.className = 'result success';
            })
            .catch(error => {
                resultDiv.innerHTML = '‚ùå Error: ' + error.message;
                resultDiv.className = 'result error';
            });
        }
    </script>
</body>
</html>
